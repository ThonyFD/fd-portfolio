image: vae/automation-base-utility
command: [sh, -c]
args:
  - >-
    cd; mkdir .ssh; cp /tmp/.ssh/* ~/.ssh; chmod 0600 ~/.ssh/*; cp /tmp/.gitconfig ~/;
    GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i ~/.ssh/ssh-private-key" git clone ssh://git@coxrepo.corp.cox.com/vae-config-templates/{{inputs.parameters.repo}}-{{inputs.parameters.environment}}.git;
    cd {{inputs.parameters.repo}}-{{inputs.parameters.environment}}; mkdir -p dcs/{{inputs.parameters.sitename}};
    [ -s /input/isc-{{inputs.parameters.serviceRole}}.yaml ] && cp /input/isc-{{inputs.parameters.serviceRole}}.yaml dcs/{{inputs.parameters.sitename}}/isc-{{inputs.parameters.parent}}.yaml;
    [ -s /input/msc-{{inputs.parameters.serviceRole}}.yaml ] && cp /input/msc-{{inputs.parameters.serviceRole}}.yaml dcs/{{inputs.parameters.sitename}}/msc-{{inputs.parameters.parent}}.yaml;
    VSBC_BASE_TEMPLATE_HASH=$(GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i ~/.ssh/ssh-private-key" git ls-remote ssh://git@coxrepo.corp.cox.com/vae-config-templates/vsbc-base-template.git 2>/dev/null | grep {{inputs.parameters.environment}} | awk '{print $1}') ;
    git add -A && git commit --allow-empty -m "applied={{inputs.parameters.apply_config}}, serviceRole={{inputs.parameters.parent}}, vsbcbase=$VSBC_BASE_TEMPLATE_HASH, env={{inputs.parameters.envHash}}, svc={{inputs.parameters.svcHash}}, generated by {{inputs.parameters.useremail}}" && GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i ~/.ssh/ssh-private-key" git push; cd;


